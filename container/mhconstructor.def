Bootstrap: docker
From: ubuntu:22.04

%post
    # For timezone
    export TZ=UTC
    export DEBIAN_FRONTEND=noninteractive

    # Install system packages
    apt-get update && apt-get install -y \
    locales \
    git \
    less \
    curl \
    bzip2 \
    wget \
    build-essential \
    gfortran \
    tzdata \
    zlib1g \
    libbz2-dev \
    liblzma-dev \
    libpcre2-dev \
    libudunits2-dev librsvg2-dev \
    libfreetype6-dev libfribidi-dev libharfbuzz-dev libfontconfig1-dev pandoc libicu-dev libjpeg-dev libpng-dev libtiff-dev make zlib1g-dev libxml2-dev libcurl4-openssl-dev libssl-dev libgit2-dev


    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    # Initialize Conda
    /opt/conda/bin/conda init
    # Update PATH
    echo 'export PATH="/opt/conda/bin:$PATH"' >> /etc/profile.d/conda.sh
    echo 'export PATH="/opt/conda/bin:$PATH"' >> ~/.bashrc
    # Create Conda environments from YAML files
    /opt/conda/bin/conda env create -f env_amosPy27.yml
    /opt/conda/bin/conda env create -f env_py35.yml
    /opt/conda/bin/conda install -n py35 pysam
    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # Install R 4.3.1
    wget https://cran.r-project.org/src/base/R-4/R-4.3.1.tar.gz 
    tar -xf R-4.3.1.tar.gz
    cd R-4.3.1
    ./configure --prefix=/opt/local/R --with-readline=no --with-x=no
    make && make install && make clean
    cd ..
    #/opt/local/R/bin/R --slave -e 'install.packages(c("data.table", "methods", "stringr", "argparser"), repos = "http://cran.us.r-project.org", dependencies = TRUE)'
    #/opt/local/R/bin/R --slave -e 'install.packages("devtools", repos="https://cloud.r-project.org/")'
    #/opt/local/R/bin/R --slave -e 'library(devtools)'
    #/opt/local/R/bin/R --slave -e 'devtools::install_github("ropensci/plotly")'

    ln -sf /usr/bin/bash /usr/bin/sh

%environment
    # UTF-8 Settings for perl
    export LC_CTYPE=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export LANGUAGE=en_US.UTF-8

    # Source the Conda profile script to activate Conda
    source /etc/profile.d/conda.sh
    export PATH="/opt/conda/bin:$PATH"
    #xport PATH=/opt/local/R/bin:${PATH}

%files
    env_amosPy27.yml
    env_py35.yml